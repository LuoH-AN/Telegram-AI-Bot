# 修复计划与执行清单（2026-02-20）

## 目标
- 修复 `url_fetch` 的内网访问风险（仅允许安全外网 HTTP/HTTPS）。
- 修复图片/文件消息在 async handler 中的阻塞式流读取。
- 修复会话临时 ID remap 缺陷，避免删除/标题更新丢失。
- 修复并发下 persona/session 错位写入与图片/文件限额绕过。
- 统一错误提示为简洁重试文案，不回显内部异常。
- 修复 provider 命令语义：改为显式 `load`。
- 修复多图片/多文件消息（media group）应按一条请求处理。

## 执行步骤
1. 底层一致性修复
- 为会话增加按 `session_id` 精确写入接口，避免依赖“当前 persona/session”。
- 在 DB 同步阶段补齐新建会话 ID remap（含 deleted/title dirty 集合）。

2. 安全边界修复（`url_fetch`）
- URL 协议仅允许 `http` / `https`。
- 拒绝本地/私网地址（含 DNS 解析后地址校验）。
- 处理重定向时逐跳重复校验，防止绕过。

3. 消息处理链路修复（图片/文件）
- 将同步流式迭代改为 `run_in_executor + async iterator`，避免阻塞事件循环。
- 增加 token limit 校验，和文本消息保持一致。
- 固定每次请求的 `persona_name + session_id` 快照，并按 `session_id` 落库。
- 错误回包改为统一：`Error. Please retry.`

4. 命令语义修复（provider）
- 加入显式命令：`/set provider load <name>`。
- 移除隐式 `/set provider <name>` 直接加载行为。
- 统一帮助文案与用法提示。

5. 多媒体分组修复
- 新增 media group 聚合逻辑：同组图片/文件只处理一次，作为一条请求送入模型。

## 验收清单
- [x] `url_fetch` 拒绝非 HTTP(S) 与内网/本地地址。
- [x] 图片、文件 handler 不再直接同步迭代流对象。
- [x] 新建会话 remap 后，`deleted_sessions` / `dirty_session_titles` 正确映射。
- [x] 图片/文件入口增加 token limit 检查。
- [x] 文本/图片/文件落库改为按固定 `session_id` 写入。
- [x] 用户错误提示统一，不回显异常细节。
- [x] provider 加载命令改为 `/set provider load <name>`。
- [x] 多图片/多文件 media group 按一条请求处理。

## 已完成验证
- `python -m compileall -q .`：通过

